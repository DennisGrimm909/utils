<html>
<head>

</head>
<body>
	<button onclick="init()">Connect to USB LED Fan</button>
	<button onclick="sendProg()">Send Program</button>
		<div id="device"></div>
	<div id="message"></div>
	<br>

<script>


// XY LED FAN
// https://github.com/fergofrog/microwave_usb_fan/tree/master/usbfan
// https://github.com/Ventto/pearlfan/issues/11
// https://github.com/fergofrog/microwave_usb_fan/blob/master/doc/csides_presentation.pdf
let deviceFilter = {
		vendorId: 0x0C45,
		productId: 0x7160
	};
	let requestParams = {
		filters: [deviceFilter]
	};
	
	var device;

	function handleDisconnectedDevice(e) {
		console.log("Device disconnected: " + e.device.productName);
		document.getElementById("message").innerHTML = "Device disconnected";
	}
	navigator.hid.addEventListener("disconnect", handleDisconnectedDevice);

	function init() {
		navigator.hid.requestDevice(requestParams).then((devices) => {
			if(devices.length == 0) return;
			devices[0].open().then(() => {
				device = devices[0];
				console.log("Opened device: " + device.productName, device);
				document.getElementById("device").innerHTML = device.productName;
			});
		});
	}

	function receiveFeatureReport() {
		device.receiveFeatureReport(0).then(dataView => {
			var buffer = dataView.buffer;
			var array = new Uint8Array(buffer);
			console.log(array);
			
		});
	}
	

// program with 2 messages (from text.py)
var prog2 = [[0,64,64,3,90,2,0,0,223,],
[0,64,35,164,34,18,164,164,131,],
[0,64,35,164,164,164,196,164,183,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,150,195,150,196,164,186,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,166,195,156,195,156,199,],
[0,64,35,196,180,196,164,196,7,],
[0,64,35,164,195,164,195,164,213,],
[0,64,35,196,166,196,162,196,247,],
[0,64,35,164,196,164,196,156,207,],
[0,64,35,196,156,196,148,195,222,],
[0,64,35,172,196,164,196,164,223,],
[0,64,35,196,180,195,156,195,253,],
[0,64,35,156,196,180,196,164,223,],
[0,64,35,196,134,195,228,196,24,],
[0,64,35,44,196,44,195,228,38,],
[0,64,35,196,134,196,164,196,217,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,193,36,84,],
[0,64,35,191,164,196,164,196,242,],
[0,64,35,164,196,164,196,180,231,],
[0,64,35,195,156,195,156,196,229,],
[0,64,35,180,196,164,196,164,231,],
[0,64,35,195,164,195,164,196,245,],
[0,64,35,166,196,162,196,164,215,],
[0,64,35,196,164,195,164,195,245,],
[0,64,35,164,196,166,196,162,215,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,108,195,124,195,124,77,],
[0,64,35,196,180,196,164,196,7,],
[0,64,35,164,195,166,196,148,200,],
[0,64,35,196,148,195,166,196,232,],
[0,64,35,164,164,164,18,164,5,],
[0,64,35,164,164,164,164,196,183,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,152,196,146,195,216,],
[0,64,35,2,196,162,196,164,51,],
[0,64,35,196,164,193,172,191,247,],
[0,64,35,156,191,156,192,180,206,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,172,196,156,196,156,207,],
[0,64,35,195,172,196,164,196,254,],
[0,64,35,164,195,164,195,36,85,],
[0,64,35,196,108,196,156,196,183,],
[0,64,35,164,196,164,196,180,231,],
[0,64,35,195,156,195,156,196,229,],
[0,64,35,180,196,164,196,164,231,],
[0,64,35,193,172,191,156,191,234,],
[0,64,35,156,192,180,196,164,219,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,108,195,124,195,124,77,],
[0,64,35,196,180,196,164,196,7,],
[0,64,35,164,195,172,196,156,214,],
[0,64,35,196,156,195,172,196,246,],
[0,64,35,164,196,164,196,180,231,],
[0,64,35,195,156,195,156,196,229,],
[0,64,35,180,196,164,196,164,231,],
[0,64,35,196,108,195,228,190,248,],
[0,64,35,228,192,108,196,164,219,],
[0,64,35,196,164,196,156,196,239,],
[0,64,35,156,196,148,195,172,198,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,108,195,124,195,124,77,],
[0,64,35,196,180,196,164,196,7,],
[0,64,35,164,196,108,195,228,222,],
[0,64,35,195,228,196,108,196,254,],
[0,64,35,164,196,164,195,108,158,],
[0,64,35,195,124,195,124,196,165,],
[0,64,35,180,196,164,196,164,231,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,220,195,46,],
[0,64,35,92,195,124,195,116,53,],
[0,64,35,196,164,196,164,195,246,],
[0,64,35,164,195,36,196,108,30,],
[0,64,35,196,156,196,164,196,239,],
[0,64,35,164,196,164,196,164,215,],
[0,64,35,196,164,196,164,196,247,],
[0,64,35,164,196,140,195,228,254,],
[0,64,35,196,196,196,196,195,54,],
[0,64,35,228,196,140,196,164,255,],
[0,64,35,196,180,195,156,195,253,],
[0,64,35,156,196,180,196,164,223,],
[0,64,35,196,164,195,166,196,248,],
[0,64,35,148,196,148,195,166,184,],
[0,64,35,196,164,164,164,164,183,],
[0,64,35,164,164,164,164,164,151,]];


async function sendProg() {

for (var i = 0 ; i < prog2.length ; i++) {

		var msg = prog2[i];
		
		console.log();
		if (calculateChecksum(msg) == msg[8]) {
			console.log("checksum OK");
		} else {
			console.log("checksum fail ", calculateChecksum(msg), msg[8]);
		}
		
		var result = await device.sendReport(0, new Uint8Array(msg));
		console.log(i, result);

}


}
	


function calculateChecksum(arr) {
var check = 0;
for (var j = 0 ; j < 8 ; j++) {
			check += arr[j];
		}
		return check & 0xff;
}
	


</script>
</body>
</html>
